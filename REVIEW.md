# Timeline Calendar Card - Package Review & Comparison with flex-table-card

## Executive Summary

### Status: ‚ùå FAILS TO LOAD - Root Cause Identified

**Problem:** The `lit` dependency is externalized in webpack.config.js, but Home Assistant doesn't provide it globally. The card bundle expects `lit` to be available at runtime, causing a module loading error.

**Solution:** Remove the `externals: { lit: 'lit' }` configuration from webpack.config.js and rebuild.

### Architecture Comparison

The `timeline-calendar-card` package differs significantly from the reference implementation (`flex-table-card`). timeline-calendar-card follows **modern TypeScript/Lit architecture**, while flex-table-card uses a **legacy single-file JavaScript** approach. Both approaches are valid, but timeline-calendar-card has one critical configuration error preventing it from loading.

## Architectural Comparison: timeline-calendar-card vs flex-table-card

### 1. **Build System** üî¥ KEY DIFFERENCE

| Aspect | timeline-calendar-card | flex-table-card | Impact |
|--------|------------------------|-----------------|--------|
| **Language** | TypeScript | JavaScript | timeline uses modern tooling |
| **Build Tool** | Webpack 5 + ts-loader | None (single file) | timeline requires build step |
| **Output** | Single bundled JS file | Single JS file | flex-table simpler distribution |
| **Configuration** | webpack.config.js | Not needed | timeline has explicit config |
| **Dependencies** | Lit (external), ts-loader, webpack | None (monolithic) | flex-table is self-contained |

### 2. **Module Architecture** üü° SIGNIFICANT DIFFERENCE

**timeline-calendar-card (Modular):**
```
src/
‚îú‚îÄ‚îÄ index.ts                    # Entry point with exports
‚îú‚îÄ‚îÄ timeline-calendar-card.ts  # Main card component  
‚îú‚îÄ‚îÄ timeline-component.ts      # UI component
‚îú‚îÄ‚îÄ types.ts                    # Type definitions
‚îú‚îÄ‚îÄ layout.ts                   # Layout algorithms
‚îú‚îÄ‚îÄ utils.ts                    # Utility functions
‚îî‚îÄ‚îÄ __tests__/                  # Unit tests
```
- ‚úÖ Separation of concerns
- ‚úÖ Testable components
- ‚úÖ Type-safe interfaces
- ‚úÖ Reusable exports
- ‚ùå Requires build process

**flex-table-card (Monolithic):**
```
flex-table-card.js            # ~1500 lines, everything in one file
‚îú‚îÄ‚îÄ CellFormatters class
‚îú‚îÄ‚îÄ DataTable class
‚îú‚îÄ‚îÄ DataRow class
‚îî‚îÄ‚îÄ FlexTableCard class
```
- ‚úÖ Simple distribution
- ‚úÖ No build required
- ‚úÖ Direct browser usage
- ‚ùå Hard to test
- ‚ùå No separation of concerns

### 3. **Web Component Registration** üü¢ COMPATIBLE

Both correctly register custom elements:

**timeline-calendar-card:**
```javascript
// Generated by @customElement decorator
customElements.define('timeline-calendar-card', TimelineCalendarCard)

// HACS registration
window.customCards.push({
  type: 'custom:timeline-calendar-card',
  name: 'Timeline Calendar Card',
  description: '...',
  preview: false,
  documentationURL: '...'
})
```

**flex-table-card:**
```javascript
customElements.define('flex-table-card', FlexTableCard)

window.customCards = window.customCards || []
window.customCards.push({
  type: 'flex-table-card',
  name: 'Flex Table Card',
  description: '...'
})
```

‚úÖ **Both use correct Home Assistant registration pattern**

### 4. **Framework Choice** üü° DIFFERENCE

| Framework | timeline-calendar-card | flex-table-card |
|-----------|------------------------|-----------------|
| **Base** | Lit (3.1.0) | Native HTMLElement |
| **Decorators** | @customElement, @property | Manual property management |
| **Templates** | Lit `html` template literals | String concatenation |
| **CSS** | Lit `css` template literals | JavaScript object literal |
| **Reactivity** | Automatic with @property | Manual update() calls |

**Impact:**
- timeline-calendar-card: More maintainable, better DX, smaller code
- flex-table-card: More compatible with older HA versions, no external deps

### 5. **External Dependencies** üî¥ KEY DIFFERENCE

**timeline-calendar-card (package.json dependencies):**
```json
{
  "dependencies": {
    "lit": "^3.1.0"  // 1 external dependency
  }
}
```

**flex-table-card:**
```javascript
// No external dependencies - completely self-contained
// Does NOT have package.json with dependencies
```

‚ö†Ô∏è **Critical Issue**: timeline-calendar-card requires `lit` to be available at runtime, but the bundled output should include it via webpack's bundling. Check that `lit` is NOT externalized.

### 6. **Build Output Verification** ‚úÖ

**timeline-calendar-card generated file:**
```javascript
// Properly registers custom element
customElements.define('timeline-calendar-card', O);  // O = minified class name
window.customCards.push({
  type: 'custom:timeline-calendar-card',
  name: 'Timeline Calendar Card',
  description: '...',
  preview: false,
  documentationURL: '...'
})
```

**File size:** 15.2 KiB (minified) - reasonable for bundled Lit + code

### 7. **Configuration Requirements** üî¥ POTENTIAL ISSUE

**flex-table-card:**
```yaml
# Simple - just needs to exist
type: custom:flex-table-card
entities:
  include: sensor.*
columns:
  - data: power
```

**timeline-calendar-card:**
```typescript
// Requires calendars property (from setConfig)
if (!config.calendars || config.calendars.length === 0) {
  throw new Error('You need to define at least one calendar')
}
```

**Issue:** timeline-calendar-card enforces `calendars` config but the Home Assistant integration isn't shown. The card may fail to load if `calendars` isn't provided.

### 8. **Home Assistant Integration** üü° INCOMPLETE

**flex-table-card:**
- ‚úÖ Full integration examples in docs
- ‚úÖ Entity filtering with include/exclude
- ‚úÖ Service/action calling
- ‚úÖ Data formatting options

**timeline-calendar-card:**
- ‚úÖ Basic card structure
- ‚ùå No `hass.states` access shown
- ‚ùå Calendar data loading not implemented (`loadEvents()` uses dummy data)
- ‚ùå No actual caldav calendar integration
- ‚ùå No entity binding

**Critical Gap:** The `loadEvents()` method generates dummy events instead of reading from Home Assistant:
```typescript
loadEvents(){
  const now = new Date()
  this.events = generateDummyEvents(now)  // ‚Üê Dummy data!
}
```

### 9. **TypeScript vs JavaScript** üü¢ BOTH VALID

| Aspect | timeline-calendar-card | flex-table-card |
|--------|------------------------|-----------------|
| **Type Safety** | Full (TypeScript) | None (JavaScript) |
| **IDE Support** | Excellent | Basic |
| **Runtime Overhead** | None (compiled away) | N/A |
| **Browser Compatibility** | Requires build | Works directly |
| **Learning Curve** | Higher | Lower |

‚úÖ **Both approaches are valid for HA custom cards**

### 10. **Testing** üü¢ timeline-calendar-card Advantage

**timeline-calendar-card:**
```
__tests__/
‚îú‚îÄ‚îÄ layout.test.ts    # 15 passing tests
‚îú‚îÄ‚îÄ utils.test.ts
‚îî‚îÄ‚îÄ test-data.test.ts
```
- Jest setup configured
- Unit tests for core logic
- TDD approach

**flex-table-card:**
- No visible test structure
- Monolithic code makes testing harder

## Why timeline-calendar-card Might Fail to Load

### Potential Issues:

1. **‚ùå Missing Home Assistant Integration**
   - The `loadEvents()` method uses dummy data
   - No actual connection to Home Assistant calendar entities
   - Config requires `calendars` property but no implementation

2. **‚ö†Ô∏è Externals Configuration**
   - Check if `lit` is in webpack externals
   - Should NOT be externalized since it's not part of HA core
   - Current webpack.config.js shows:
     ```javascript
     externals: {
       lit: 'lit',  // ‚Üê This might be the problem!
     }
     ```

3. **üî¥ Lit Dependency Not Available**
   - The bundled output assumes `lit` is globally available
   - Home Assistant doesn't provide `lit` globally
   - Need to bundle `lit` into the output file

4. **‚ùå No Event Data Loading**
   - Card registers but has no calendar data source
   - `hass` property is unused
   - No state subscriptions

### Comparison with flex-table-card Success:

flex-table-card works because:
1. ‚úÖ Everything is self-contained (no external deps)
2. ‚úÖ Pure vanilla JavaScript
3. ‚úÖ Direct DOM manipulation (no framework)
4. ‚úÖ Reads from `hass.states` directly
5. ‚úÖ No build step needed

## Root Cause Analysis: Why Card Fails to Load

### Primary Issue: `lit` Externalized in webpack.config.js

**Current Configuration (PROBLEMATIC):**
```javascript
// webpack.config.js
export default {
  // ... other config
  externals: {
    lit: 'lit',  // ‚Üê PROBLEM: Expects 'lit' to be globally available
  },
}
```

**What happens:**
1. Webpack sees `import { LitElement, html, css } from 'lit'`
2. Instead of bundling the `lit` library, it creates a reference: `require('lit')`
3. At runtime in Home Assistant, `lit` is not globally available
4. Card fails to load: `Uncaught Error: Cannot find module 'lit'`

**Solution:** Remove or comment out the `lit` externals line to bundle it

### Secondary Issue: No Actual Calendar Data Loading

Even if the Lit dependency is fixed, the card won't display data because:

```typescript
// timeline-calendar-card.ts
setConfig(config: TimelineCalendarConfig) {
  if (!config.calendars || config.calendars.length === 0) {
    throw new Error('You need to define at least one calendar')
  }
  this.config = config
}

loadEvents() {
  const now = new Date()
  this.events = generateDummyEvents(now)  // ‚Üê Dummy data, not from HA!
}
```

The card:
- ‚ùå Doesn't read from `hass.states`
- ‚ùå Doesn't support caldav integration
- ‚ùå Doesn't implement calendar entity binding
- ‚úÖ Only shows hardcoded dummy events

## Recommendations

### Immediate Fixes (To Get Card Loading)

1. **Fix webpack externals:**
   ```javascript
   // webpack.config.js - REMOVE or MODIFY:
   export default {
     // ... rest of config
     // externals: {
     //   lit: 'lit',  // REMOVE THIS LINE - bundle lit instead
     // },
   }
   ```

2. **Rebuild:**
   ```bash
   npm run build
   ```

3. **Test in Home Assistant:**
   ```yaml
   type: custom:timeline-calendar-card
   calendars: []  # Even empty array to bypass validation
   ```

### Long-term Fixes (To Make Card Functional)

1. **Implement calendar data loading:**
   ```typescript
   loadEvents() {
     if (!this.hass || !this.config?.calendars) return
     
     // Read from hass.states for calendar entities
     const events = []
     for (const calendarId of this.config.calendars) {
       const state = this.hass.states[`calendar.${calendarId}`]
       if (state?.attributes?.events) {
         events.push(...state.attributes.events)
       }
     }
     this.events = events
   }
   ```

2. **Add caldav calendar support** (if not using built-in HA calendars)

3. **Implement entity subscriptions** using `subscribeEntities()`

4. **Add configuration UI** for calendar selection

## File-by-File Comparison

### webpack.config.js

**timeline-calendar-card:**
```javascript
import path from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

export default {
  mode: 'production',
  entry: './src/timeline-calendar-card.ts',
  output: {
    filename: 'timeline-calendar-card.js',
    path: path.resolve(__dirname, 'dist'),
  },
  module: {
    rules: [
      {
        test: /\.ts$/,
        use: 'ts-loader',
        exclude: /node_modules/,
      },
    ],
  },
  resolve: {
    extensions: ['.ts', '.js'],
  },
  devtool: 'source-map',
  externals: {
    lit: 'lit',  // ‚Üê ISSUE: Don't externalize lit
  },
}
```

**flex-table-card:**
- No webpack config (single file, no build needed)

### package.json Dependencies

**timeline-calendar-card:**
```json
{
  "dependencies": {
    "lit": "^3.1.0"
  },
  "devDependencies": {
    "@babel/preset-env": "^7.23.0",
    "@babel/preset-typescript": "^7.23.0",
    "@types/jest": "^29.5.0",
    "babel-loader": "^9.1.3",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "ts-jest": "^29.1.1",
    "ts-loader": "^9.5.0",
    "typescript": "^5.2.0",
    "webpack": "^5.89.0",
    "webpack-cli": "^5.1.0"
  }
}
```

**flex-table-card:**
- No package.json with dependencies (single JS file)

### hacs.json

**Both are properly configured:**

timeline-calendar-card:
```json
{
  "name": "Timeline Calendar Card",
  "domains": ["calendar"],
  "homeassistant": "2024.1.0",
  "render_readme": true
}
```

flex-table-card:
```json
{
  "name": "Flex Table Card",
  "domains": ["custom_card"],
  // ... similar structure
}
```

‚úÖ Both comply with HACS standards

## Summary Table

| Aspect | timeline-calendar-card | flex-table-card | Status |
|--------|------------------------|-----------------|--------|
| **Language** | TypeScript | JavaScript | Different, both valid |
| **Framework** | Lit | Vanilla HTMLElement | Different, both valid |
| **Build Required** | Yes (webpack) | No | timeline more complex |
| **External Dependencies** | lit (incorrectly externalized) | None | timeline has issue |
| **Module System** | ES Modules | Monolithic | timeline more maintainable |
| **Tests** | Jest tests present | No tests | timeline advantage |
| **HA Integration** | Incomplete (dummy data) | Complete | flex-table advantage |
| **Load Status** | ‚ùå Fails (lit externalized) | ‚úÖ Works | timeline needs fix |
| **Data Loading** | ‚ùå Hardcoded dummy events | ‚úÖ From hass.states | flex-table advantage |
| **Documentation** | Basic | Extensive | flex-table advantage |

## Conclusion

**Why timeline-calendar-card fails to load:**
1. **Primary:** `lit` is externalized in webpack, but Home Assistant doesn't provide it globally
2. **Secondary:** No actual calendar data integration (uses dummy data)

**Why flex-table-card works:**
1. Single file, no external dependencies
2. Self-contained vanilla JavaScript
3. Direct integration with Home Assistant state

**To fix timeline-calendar-card:**
1. Remove `externals: { lit: 'lit' }` from webpack.config.js
2. Rebuild: `npm run build`
3. Implement actual calendar data loading in `loadEvents()`
2. Install "Timeline Calendar Card"
3. Add resource in dashboard configuration:
   ```yaml
   resources:
     - url: /local/community/timeline-calendar-card/timeline-calendar-card.js
       type: module
   ```
4. Add card to dashboard:
   ```yaml
   type: custom:timeline-calendar-card
   calendars:
     - calendar.my_calendar
   ```

### For Development

```bash
# Install dependencies
npm install

# Development build with watch
npm run dev

# Production build
npm run build

# Run tests
npm test
```

## Build Output Details

The webpack configuration generates:
- **Main bundle:** `timeline-calendar-card.js` (15.2 KiB minified)
- **Source maps:** For debugging with original TypeScript
- **Type definitions:** For IDE support and type checking
- **License file:** Third-party dependencies attribution

## Recommendations

### Current Implementation ‚úÖ

The package now follows Home Assistant custom card best practices:
1. ‚úÖ Consistent naming throughout
2. ‚úÖ Proper folder structure
3. ‚úÖ HACS-compliant configuration
4. ‚úÖ Modern TypeScript implementation
5. ‚úÖ Proper custom element registration

### Potential Future Enhancements

1. **Editor Support** - Add `getConfigElement()` and `getStubConfig()` for visual configuration
2. **Grid Options** - Implement `getGridOptions()` for sections view support (HA 2024.1+)
3. **Error Handling** - Add configuration validation and user-friendly error messages
4. **Testing** - Expand unit test coverage for layout and utility functions
5. **Documentation** - Add inline code documentation and configuration examples

## References

- [Home Assistant Custom Card Documentation](https://developers.home-assistant.io/docs/frontend/custom-ui/custom-card/)
- [HACS Tutorial Organization](https://github.com/home-assistant-tutorials)
- [Lit Element Framework](https://lit.dev/)
- [TypeScript in Home Assistant](https://developers.home-assistant.io/docs/frontend/custom-ui/custom-card/)

## Verification

To verify the installation in Home Assistant:

1. Copy `dist/timeline-calendar-card.js` to `/config/www/timeline-calendar-card/`
2. Add resource to dashboard:
   ```yaml
   resources:
     - url: /local/timeline-calendar-card/timeline-calendar-card.js
       type: module
   ```
3. Add the card to a dashboard and verify it appears in the card picker as "Timeline Calendar Card"

---

**Review Date:** January 18, 2026  
**Status:** ‚úÖ COMPLIANT - All naming and structure issues resolved
